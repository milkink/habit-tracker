<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Micro-Habit Builder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>

    <!-- Welcome Header -->
    <div class="welcome-header">
        <h2>Welcome, {{ current_user.username }}!</h2>
        <a href="{{ url_for('logout') }}" class="logout-link">Log Out</a>
    </div>

    <!-- Habit Form -->
    <div class="habit-form-container">
        <form id="habit-form">
            <input type="text" id="habit-name" placeholder="Habit Name" required>
            <input type="text" id="habit-frequency" placeholder="Frequency (e.g., Daily)" required>
            <button type="submit" class="add-habit-btn">Add Habit</button>
        </form>
    </div>

    <!-- Habit List -->
    <h2>Your Habits</h2>
    <ul id="habit-list">
        {% for habit in habits %}
            <li>
                <label>
                    <input type="checkbox" 
                           class="habit-checkbox" 
                           data-habit-id="{{ habit[0] }}" 
                           {% if habit[3] == 1 %} checked {% endif %}>
                    {{ habit[1] }} ({{ habit[2] }}) - Streak: <span id="habit-streak-{{ habit[0] }}">{{ habit[4] }}</span>
                </label>
                <!-- Remove button for each habit -->
                <button class="remove-btn" data-habit-id="{{ habit[0] }}">Remove</button>
            </li>
        {% else %}
            <p>No habits found. Start adding some!</p>
        {% endfor %}
    </ul>

    <!-- Link to Habit Calendar -->
    <h2><a href="{{ url_for('calendar') }}">View Habit Calendar</a></h2>

    <!-- Link to Analytics -->
    <h2><a href="{{ url_for('analytics') }}">View Habit Analytics</a></h2>

    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        // Handle habit checkbox change
        $(document).on('change', '.habit-checkbox', function() {
            const habitId = $(this).data('habit-id');
            const isCompleted = $(this).prop('checked') ? 1 : 0;

            // Fetch the current streak
            const currentStreak = parseInt($("#habit-streak-" + habitId).text());

            $.ajax({
                url: '/update_habit_completion/' + habitId,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ is_completed: isCompleted }),
                success: function(response) {
                    if (response.streak !== undefined) {
                        // If the streak has been updated, display the new streak
                        $("#habit-streak-" + habitId).text(response.streak);
                    } else {
                        // Show any message from the backend (like already clicked for today)
                        alert(response.message);
                    }
                },
                error: function(error) {
                    alert('Error updating habit completion.');
                }
            });
        });

        // Handle form submission for adding a new habit
        $('#habit-form').submit(function(e) {
            e.preventDefault();
            const habitName = $('#habit-name').val();
            const habitFrequency = $('#habit-frequency').val();

            if (!habitName || !habitFrequency) {
                alert('Both habit name and frequency are required.');
                return;
            }

            $.ajax({
                url: '/add_habit',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    habit_name: habitName,
                    habit_frequency: habitFrequency
                }),
                success: function(response) {
                    alert(response.message);
                    location.reload();  // Reload the page to show the new habit
                },
                error: function(error) {
                    alert('Error adding habit.');
                }
            });
        });

        // Handle habit removal
        $(document).on('click', '.remove-btn', function() {
            const habitId = $(this).data('habit-id');

            if (confirm('Are you sure you want to remove this habit?')) {
                $.ajax({
                    url: '/remove_habit/' + habitId,
                    type: 'DELETE',
                    success: function(response) {
                        alert(response.message);  // Show success message
                        $(this).closest('li').remove();  // Remove the habit from the list (without reloading the page)
                    },
                    error: function(error) {
                        alert('Error removing habit.');
                    }
                });
            }
        });
    </script>

</body>
</html>
